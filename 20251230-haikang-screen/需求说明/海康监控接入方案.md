# 海康威视监控接入方案

## 1. 概述
本方案旨在将海康威视（Hikvision）的实时监控画面接入到智慧城市大屏的“重点监控”模块中。使用海康提供的 Web SDK (无插件版 V3.4.0) 实现视频流的播放与控制。

## 2. 准备工作

### 2.1 依赖文件
需将 SDK 中的以下核心文件引入到项目中（建议放在 `public/static/` 或 `src/assets/libs/` 目录下）：
- `jquery.min.js` (SDK依赖)
- `webVideoCtrl.js` (核心控制库)
- `jsPlugin-1.0.0.min.js` (解码插件，具体版本视SDK而定)

### 2.2 设备信息
接入前需确认 NVR 或 摄像头的以下信息：
- **IP地址** (e.g., 192.168.1.64)
- **端口号** (HTTP端口，默认为 80)
- **用户名** (e.g., admin)
- **密码**
- **通道号** (需播放的具体通道ID)

## 3. 接入流程

整体流程为：**加载SDK -> 初始化插件 -> 自动登录 -> 获取通道 -> 开始预览**。

### 3.1 引入 SDK
在 `index.html` 或组件中动态加载脚本：
```html
<script src="/libs/jquery.min.js"></script>
<script src="/libs/webVideoCtrl.js"></script>
```

### 3.2 组件初始化 (React useEffect)
在 React 组件挂载时初始化插件。

```javascript
useEffect(() => {
  // 1. 检查浏览器支持
  if (!window.WebVideoCtrl.I_SupportNoPlugin()) {
    console.error("当前浏览器不支持无插件播放");
    return;
  }

  // 2. 初始化插件
  window.WebVideoCtrl.I_InitPlugin(width, height, {
    bWndFull: true,
    iWndowType: 1,
    cbInitPluginComplete: function () {
      window.WebVideoCtrl.I_InsertOBJECTPlugin("divPluginId");
      // 初始化完成后尝试自动登录
      autoLogin(); 
    }
  });

  return () => {
    // 组件卸载时停止播放并登出
    stopAndLogout();
  };
}, []);
```

### 3.3 自动登录与缓存策略
为了避免每次刷新页面都需要手动登录，采用 `localStorage` 缓存登录凭证。

**缓存策略：**
1.  **首次使用**：用户输入 IP、端口、账号、密码。
2.  **登录成功**：将凭证加密（或Base64编码）存储到 `localStorage`。
3.  **再次访问**：组件加载时读取 `localStorage`，若存在凭证则自动调用 `I_Login`。

**自动登录代码示例：**
```javascript
const autoLogin = () => {
  const cachedCreds = localStorage.getItem('hik_credentials');
  if (!cachedCreds) return; // 无缓存，等待用户手动输入

  const { ip, port, user, pass } = JSON.parse(cachedCreds);
  
  // 登录海康设备
  window.WebVideoCtrl.I_Login(ip, 1, port, user, pass, {
    success: (xmlDoc) => {
      console.log("自动登录成功");
      // 获取通道并播放
      getChannelsAndPlay(ip); 
    },
    error: (status, xmlDoc) => {
      console.error("自动登录失败，请检查账号密码或网络");
    }
  });
};
```

### 3.4 获取通道与预览
登录成功后，需获取数字通道或模拟通道列表，然后选择一个通道进行预览。

```javascript
const getChannelsAndPlay = (ip) => {
  // 获取数字通道
  window.WebVideoCtrl.I_GetDigitalChannelInfo(ip, {
    async: false,
    success: (xmlDoc) => {
      const channels = $(xmlDoc).find("InputProxyChannelStatus");
      // 假设取第一个在线通道
      let firstChannelId = null;
      $.each(channels, function() {
         if ($(this).find("online").text() === "true") {
           firstChannelId = $(this).find("id").text();
           return false; // break
         }
      });

      if (firstChannelId) {
        startPreview(ip, firstChannelId);
      }
    }
  });
};

const startPreview = (ip, channelId) => {
  window.WebVideoCtrl.I_StartRealPlay(ip, {
    iStreamType: 1, // 1: 子码流 (流畅), 2: 主码流 (高清)
    iChannelID: channelId,
    bZeroChannel: false,
    success: () => console.log("预览开始"),
    error: () => console.error("预览失败")
  });
};
```

## 4. 异常处理与注意事项

1.  **跨域问题**：Web SDK 通常需要通过 Nginx 代理转发，或者设备需开启 WebSocket/CORS 支持。若遇跨域，需配置 Nginx 反向代理。
2.  **性能优化**：
    - 页面切换或组件销毁时，务必调用 `I_Stop` 和 `I_Logout` 释放资源。
    - 监控画面较小（如右侧小窗）时，建议强制使用**子码流** (`iStreamType: 2`) 以降低带宽占用。
3.  **安全性**：`localStorage` 存储密码存在安全风险。建议：
    - 仅在内网环境使用。
    - 后续考虑通过后端 API 获取临时的 Token 或加密后的凭证，不直接在前端暴露明文密码。

## 5. 开发计划

- [ ] **Step 1**: 搭建测试页面，验证 `demo.js` 在当前网络环境下的连通性。
- [ ] **Step 2**: 封装 React 组件 `HikVideoPlayer`，集成上述初始化与登录逻辑。
- [ ] **Step 3**: 实现配置面板（隐藏式），用于首次输入设备信息并保存到 LocalStorage。
- [ ] **Step 4**: 替换大屏右侧静态图片为 `HikVideoPlayer` 组件。
